<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Repositories\ContactsRepository;
use App\Contact;


use App\Http\Requests;
use Mail;

class ContactController extends SiteController
{
    public function __construct(ContactsRepository $con_rep)
    {

        parent::__construct(new \App\Repositories\MenusRepository(new \App\Menu),
            new \App\Repositories\FooterRepository(new \App\Footer),
            new \App\Repositories\LogoRepository(new \App\Logo),
            new \App\Repositories\PortfolioRepository(new \App\Portfolio));

        $this->con_rep = $con_rep;
        $this->template = env('THEME') . '.contact';
    }

    public function index(Request $request)
    {
        $this->title = 'Контакты';
        $this->keywords = 'Контакты Web разработчика';
        $this->meta_desc = 'Контакты Web разработчика';

        if ($request->isMethod('post')) {

            $messages = [
                'name.required' => '&#9998; Имя не заполнено',
                'text.required' => '&#9998; Напишите сообщение',
                'email.required' => '&#9998; Укажите Ваш Email',
                'email'    => 'Укажите правильный email адрес',
            ];

            $this->validate($request, [
                'name' => 'required|max:255',
                'email' => 'required|email',
                'text' => 'required'
            ],$messages);

            $data = $request->all();

            $result = Mail::send(env('THEME').'.email', ['data' => $data], function ($m) use ($data) {
                $mail_admin = env('MAIL_ADMIN');
                $mail_to = env('MAIL_TO');

                $m->from($mail_to, $data['email']);

                $m->to($mail_admin,'')->subject('Dexploitdm.ru | Разработка сайтов');
            });

            return redirect()->route('contact')->with('status', 'Сообщение отправленно &#9993;&raquo;');

        }


        $contact = $this->getContacts();
        $content = view(env('THEME') . '.contact_content')->with('contact', $contact)->render();
        $this->vars = array_add($this->vars, 'content', $content);

        return $this->renderOutput();
    }

    public function getContacts() {
        $contacts = $this->con_rep->get();
        return $contacts;
    }
}
